# Phase 4 Plan 3: Update Export to Show Relationships

## Objective

Enhance project export to include entity relationships in both JSON and Markdown formats.

## Context

From ROADMAP.md Phase 4 requirements:
- Update export to include linked relationships

Current export in `src/storage/index.ts` has `exportProjectToMarkdown()` that exports entities without relationship info.

## Tasks

### Task 1: Update JSON export to include links
**File:** `src/storage/index.ts`

Modify export logic to include resolved linkedEntities in JSON output. The entities already have `linkedEntities` array from schema, but we want to include entity names for readability:

```typescript
// In exportProjectToJson or equivalent
for (const entityRef of project.entities) {
  const entity = await getEntity(entityRef.id);
  if (entity?.linkedEntities?.length) {
    // Resolve linked entity names for better readability
    entity.linkedEntityDetails = await Promise.all(
      entity.linkedEntities.map(async (link) => {
        const linked = await getEntity(link.id);
        return {
          ...link,
          name: linked?.name || "Unknown",
        };
      })
    );
  }
}
```

**Commit:** `feat(export): include resolved links in JSON export`

### Task 2: Update Markdown export to show relationships
**File:** `src/storage/index.ts`

Add a "Linked Entities" section to each entity in markdown output:

```typescript
// In exportProjectToMarkdown
if (entity.linkedEntities?.length) {
  markdown += "\n### Linked Entities\n\n";
  for (const link of entity.linkedEntities) {
    const linked = await getEntity(link.id);
    const name = linked?.name || link.id;
    const rel = link.relationship ? ` (${link.relationship})` : "";
    markdown += `- **${linked?.type}**: ${name}${rel}\n`;
  }
}
```

**Commit:** `feat(export): show entity relationships in markdown export`

### Task 3: Add relationship summary section
**File:** `src/storage/index.ts`

Add a "Relationships Overview" section at the end of markdown export showing all connections:

```typescript
// After all entities
markdown += "\n## Relationships Overview\n\n";
const relationships = collectAllRelationships(entities);
if (relationships.length) {
  for (const rel of relationships) {
    markdown += `- ${rel.sourceName} â†’ ${rel.targetName}`;
    if (rel.relationship) markdown += ` (${rel.relationship})`;
    markdown += "\n";
  }
} else {
  markdown += "No entity relationships defined.\n";
}
```

**Commit:** `feat(export): add relationships overview section`

### Task 4: Add export tests for linked entities
**File:** `src/storage/export.test.ts` or `src/tools/project.test.ts`

Test cases:
- JSON export includes linkedEntities with resolved names
- Markdown export shows "Linked Entities" section per entity
- Markdown export includes "Relationships Overview" section
- Export handles entities with no links gracefully

**Commit:** `test(export): add linked entity export tests`

## Verification

```bash
npm test
npm run build
```

## Dependencies

Requires 04-01 (schema) and 04-02 (tools for creating test links).
